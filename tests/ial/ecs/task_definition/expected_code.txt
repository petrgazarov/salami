ecs.TaskDefinition(
    "CumuliServerTaskDefinition",
    family="cumuli-server",
    cpu="256",
    memory="512",
    network_mode="awsvpc",
    task_role_arn=ecs_task_role.arn,
    requires_compatibilities=["FARGATE"],
    execution_role_arn=execution_role.arn,
    tags={"Name": "cumuli-server-task-definition"},
    container_definitions=pulumi.Output.all(ecr_repo.repository_url, log_group.name, aws_region).apply(
        lambda outputs: json.dumps(
            [
                {
                    "name": container_name,
                    "image": f"{args[0]}:latest",
                    "memory": 512,
                    "cpu": 256,
                    "essential": True,
                    "portMappings": [{"containerPort": container_port}],
                    "environment": [
                        {
                            "name": "OPENAI_API_KEY",
                            "value": os.environ["OPENAI_API_KEY"],
                        },
                        {
                            "name": "ASSUMED_ROLE_SECRET_TOKEN",
                            "value": os.environ["ASSUMED_ROLE_SECRET_TOKEN"],
                        },
                        {
                            "name": "PYTHON_EXEC_URL",
                            "value": (
                                f"{python_exec_local_service_name}."
                                + local_dns_namespace_name
                                + f":{container_port}"
                            ),
                        },
                    ],
                    "logConfiguration": {
                        "logDriver": "awslogs",
                        "options": {
                            "awslogs-group": args[1],
                            "awslogs-region": args[2],
                            "awslogs-stream-prefix": "ecs",
                        },
                    },
                }
            ]
        )
    ),
)
