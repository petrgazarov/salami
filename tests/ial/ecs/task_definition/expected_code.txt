ecs.TaskDefinition(
    "CumuliServerTaskDefinition",
    family="cumuli-server",
    cpu="256",
    memory="512",
    network_mode="awsvpc",
    task_role_arn=cumuli_server_task_role.arn,
    requires_compatibilities=["FARGATE"],
    execution_role_arn=cumuli_ecs_execution_role.arn,
    tags={"Name": "cumuli-server-task-definition"},
    container_definitions=pulumi.Output.all(
        cumuli_server_repository.repository_url,
        cumuli_server_log_group.name
    ).apply(
        lambda args: json.dumps(
            [
                {
                    "name": server_container_name,
                    "image": f"{args[0]}:latest",
                    "memory": 512,
                    "cpu": 256,
                    "essential": True,
                    "portMappings": [{"containerPort": container_port, "protocol": "tcp"}],
                    "environment": [
                        {
                            "name": "OPENAI_API_KEY",
                            "value": os.environ["OPENAI_API_KEY"],
                        },
                        {
                            "name": "ASSUMED_ROLE_SECRET_TOKEN",
                            "value": os.environ["ASSUMED_ROLE_SECRET_TOKEN"],
                        },
                        {
                            "name": "PYTHON_EXEC_URL",
                            "value": (
                                f"{python_exec_local_service_name}."
                                + local_dns_namespace_name
                                + f":{container_port}"
                            ),
                        },
                    ],
                    "logConfiguration": {
                        "logDriver": "awslogs",
                        "options": {
                            "awslogs-group": args[1],
                            "awslogs-region": aws_region,
                            "awslogs-stream-prefix": "ecs",
                        },
                    },
                }
            ]
        )
    ),
)
